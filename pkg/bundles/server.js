var e=function(){return(e=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};var t="SEND_RESPONSE",n="STREAM_PUMP",r="STREAM_END",o="FETCH_REQUEST",i="VERIFY_COMM_RELAY";var a=new(function(){function a(e){this.__relayPath=e.relayPath}return a.prototype.refreshAllClients=function(){return self.clients.matchAll({type:"window"}).then(function(e){e.forEach(function(e){e.navigate(e.url)})})},a.prototype.handleClientMessage=function(e){var t=this;return new Promise(function(n,r){var o=e.data,a=o.type,l=(o.payload,function(){n({status:"no-match"})});return a&&a===i?t.getCommRelays().then(function(t){e.ports[0]&&e.ports[0].postMessage({exists:0!==t.length}),n({status:"success"})}):l()})},a.prototype.controllerFetch=function(e){var t=this;return function(e){var t={url:e.url,init:{}};["method","mode","credentials","cache","redirect","referrer","integrity"].forEach(function(n){e[n]&&(t[n]=e[n])});var n={};return e.headers.forEach(function(e,t){n[t]=e}),Object.keys(n).length>0&&(t.init.headers=n),e.blob().then(function(e){return 0!==e.size&&(t.init.body=e),t})}(e).then(function(e){return t.sendRequestToRelay({type:o,payload:e}).then(function(e){return function(e){return new Response(e.body,e.init)}(e)})})},a.prototype.sendRequestToRelay=function(o){var i=[];return this.getCommRelays().then(function(a){return a.forEach(function(a){return i.push(self.ReadableStream?function(o,i){return new Promise(function(a,l){var s=new MessageChannel,c=new ReadableStream({start:function(u){s.port1.onmessage=function(o){var i=o.data,f=i.type,h=i.payload;if(o.data.error)l(o.data.error);else if(f===t){var d=e({},h);d.streamBody?d.body=c:(s.port1.close(),s.port2.close(),s=null),a(d)}else if(f===n)u.enqueue(h);else if(f===r)return u.close(),s.port1.close(),s.port2.close(),void(s=null)},o.postMessage(i,[s.port2])}})})}(a,o):function(n,r){return new Promise(function(o,i){var a=new MessageChannel;a.port1.onmessage=function(n){var r=n.data,l=r.type,s=r.payload;if(n.data.error)i(n.data.error);else if(l===t){var c=e({},s);a.port1.close(),a.port2.close(),a=null,o(c)}},n.postMessage(r,[a.port2])})}(a,o))}),Promise.race(i)})},a.prototype.getCommRelays=function(){var e=this;return self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then(function(t){return t.filter(function(t){return 0===new URL(t.url).pathname.indexOf(e.__relayPath)})})},a.prototype.getClients=function(){var e=this;return self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then(function(t){return t.filter(function(t){return 0!==new URL(t.url).pathname.indexOf(e.__relayPath)})})},a.prototype.controllerConnected=function(){return this.getCommRelays().then(function(e){return e.length>0})},a.prototype.refreshAllWindows=function(e){var t=this;void 0===e&&(e={includeRelay:!1}),self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then(function(n){n.forEach(function(n){(e.includeRelay||!e.includeRelay&&0!==new URL(n.url).pathname.indexOf(t.__relayPath))&&n.navigate(n.url)})})},a}())({relayPath:"/__commrelay__.html"});self.addEventListener("install",function(e){e.waitUntil(self.skipWaiting())}),self.addEventListener("activate",function(e){a.refreshAllWindows(),e.waitUntil(clients.claim())}),self.addEventListener("fetch",function(e){var t=e.request;if(new URL(t.url).origin===location.origin)return e.respondWith(a.controllerConnected().then(function(e){if(e)return a.controllerFetch(t)}))}),self.addEventListener("message",function(e){e.waitUntil(a.handleClientMessage(e))});
